<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./css/styles.css">
  <title></title>
</head>

<body>
  <div id="app"></div>

  <script src="./js/nElement.js"></script>
  <script src="./js/api.js"></script>
  <script>
    const { address = '0.0.0.0:8080' } = Flow.fromTo('client.html')

    const socket = new WebSocket('ws://' + address)

    socket.name = ''

    const send = (type, text) => [
      socket.send(JSON.stringify({ type, text })),
      console.log({ type, text }),
    ]

    const app = nElement.fromId('app')
    app.addContainerClass('app')

    const client = new nFlex()
    app.append(client)

    const buttons = new nElement()
    buttons.addContainerClass('buttons')
    client.append(buttons)

    const addButton = (color) => {
      const button = new nElement()
      button.addContainerClass('button')

      button.setContainerStyle('background-color', color)
      button.on('click', () => send('button', color))

      button.setText(color.substring(0, 1).toUpperCase())
      buttons.append(button)
    }

    addButton('yellow')
    addButton('green')
    addButton('orange')
    addButton('white')
    addButton('blue')
    addButton('red')

    const joystick = new nElement()
    joystick.addContainerClass('joystick')
    client.append(joystick)

    const joystickButton = new nElement()
    joystickButton.addContainerClass('joystickButton')

    const joystickPositions = { clientX: 0, clientY: 0 }

    joystickButton.onContainer('touchstart', (ev) => {
      const { clientX, clientY } = ev.changedTouches.item(0)
      joystickPositions.clientX = clientX
      joystickPositions.clientY = clientY
    })

    joystickButton.onContainer('touchend', ({ changedTouches }) => {
      const { clientX, clientY } = changedTouches.item(0)
      const [x, y] = [
        clientX - joystickPositions.clientX,
        clientY - joystickPositions.clientY,
      ]

      send('move', { x, y })
    })

    joystick.append(joystickButton)

  </script>

</body>

</html>