<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title></title>
</head>

<body>
  <div id="app"></div>

  <script src="./js/nElement.js"></script>
  <script src="./js/api.js"></script>
  <script>
    const { address = '0.0.0.0:8080' } = Flow.fromTo('client.html')

    const socket = new WebSocket('ws://' + address)

    socket.name = ''

    const send = (type, text) => [
      socket.send(JSON.stringify({ type, text })),
      console.log({ type, text }),
    ]

    // Application

    const app = nElement.fromId('app')

    const client = new nFlex()
    app.append(client)

    const buttons = new nElement()
    buttons.setStyle('width', '50%')
    client.append(buttons)

    const addButton = (color) => {
      const button = new nElement()

      button.setContainerStyle('display', 'inline-block')

      button.setStyle('box-shadow', '0rem 0rem 0rem calc(1rem / 8) black')
      button.setStyle('background-color', color)
      button.setStyle('display', 'inline-block')
      button.setStyle('border-radius', '50%')
      button.setStyle('text-align', 'center')
      button.setStyle('padding', '1rem')
      button.setStyle('height', '3rem')
      button.setStyle('margin', 'calc(1rem / 4)')
      button.setStyle('width', '3rem')

      button.on('click', () => send('button', color))

      button.setText(color.substring(0, 1).toUpperCase())
      buttons.append(button)
    }

    addButton('yellow')
    addButton('green')
    addButton('orange')
    addButton('white')
    addButton('blue')
    addButton('red')

    const joystick = new nElement()
    joystick.setStyle('background-color', '#666666')
    joystick.setStyle('display', 'inline-block')
    joystick.setStyle('border-radius', '50%')
    joystick.setStyle('margin', '30vh 10vh')
    joystick.setStyle('padding', '7.5vh')
    joystick.setStyle('height', '30vh')
    joystick.setStyle('width', '30vh')
    client.append(joystick)

    const joystickButton = new nElement()
    joystickButton.setContainerStyle('border-radius', '50%')
    joystickButton.setContainerStyle('background-color', '#cccccc')
    joystickButton.setContainerStyle('height', '15vh')
    joystickButton.setContainerStyle('width', '15vh')

    const joystickPositions = { clientX: 0, clientY: 0 }

    joystickButton.onContainer('touchstart', (ev) => {
      const { clientX, clientY } = ev.changedTouches.item(0)
      joystickPositions.clientX = clientX
      joystickPositions.clientY = clientY
    })

    joystickButton.onContainer('touchend', ({ changedTouches }) => {
      const { clientX, clientY } = changedTouches.item(0)
      const [x, y] = [
        clientX - joystickPositions.clientX,
        clientY - joystickPositions.clientY,
      ]

      send('move', { x, y })
    })

    joystick.append(joystickButton)

  </script>

</body>

</html>